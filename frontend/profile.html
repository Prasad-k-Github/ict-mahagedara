<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Prasad K. Gamage Learning Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .page-header {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        padding: 30px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-header h1 {
        color: #667eea;
        font-size: 28px;
      }

      .back-btn {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .back-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .profile-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        padding: 30px;
      }

      .card-title {
        color: #667eea;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #666;
      }

      .info-value {
        color: #333;
        font-weight: 500;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      input,
      select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.3s;
        font-family: inherit;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.show {
        display: block;
        animation: slideDown 0.3s ease-out;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #667eea;
      }

      .loading.show {
        display: block;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      @media (max-width: 768px) {
        .profile-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }

      .danger-zone {
        border: 2px solid #dc3545;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .danger-zone h3 {
        color: #dc3545;
        margin-bottom: 10px;
      }

      .danger-zone p {
        color: #666;
        margin-bottom: 15px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Page Header -->
      <div class="page-header">
        <h1>üë§ My Profile</h1>
        <a href="index.html" class="back-btn">‚Üê Back to Chat</a>
      </div>

      <!-- Alert Messages -->
      <div id="alertSuccess" class="alert alert-success"></div>
      <div id="alertError" class="alert alert-error"></div>
      <div id="loading" class="loading">Loading...</div>

      <!-- Profile Grid -->
      <div class="profile-grid">
        <!-- Profile Information -->
        <div class="profile-card">
          <h2 class="card-title">üìã Profile Information</h2>
          <div id="profileInfo">
            <div class="info-row">
              <span class="info-label">Full Name:</span>
              <span class="info-value" id="displayFullName">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value" id="displayEmail">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Phone:</span>
              <span class="info-value" id="displayPhone">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Birthday:</span>
              <span class="info-value" id="displayBirthday">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Age:</span>
              <span class="info-value" id="displayAge">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Gender:</span>
              <span class="info-value" id="displayGender">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Grade Level:</span>
              <span class="info-value" id="displayGrade">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Language:</span>
              <span class="info-value" id="displayLanguage">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status:</span>
              <span class="info-value">
                <span id="displayStatus" class="status-badge">-</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Account Statistics -->
        <div class="profile-card">
          <h2 class="card-title">üìä Account Statistics</h2>
          <div class="stat-card">
            <div class="stat-value" id="statAge">-</div>
            <div class="stat-label">Years Old</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statGrade">-</div>
            <div class="stat-label">Grade Level</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAccountAge">-</div>
            <div class="stat-label">Days on Platform</div>
          </div>
          <div class="info-row">
            <span class="info-label">Account Created:</span>
            <span class="info-value" id="statCreated">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Last Login:</span>
            <span class="info-value" id="statLastLogin">-</span>
          </div>
        </div>

        <!-- Edit Profile -->
        <div class="profile-card">
          <h2 class="card-title">‚úèÔ∏è Edit Profile</h2>
          <form id="updateProfileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" placeholder="First Name" />
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" placeholder="Last Name" />
              </div>
            </div>

            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="text" id="phoneNumber" placeholder="07XXXXXXXX" />
            </div>

            <div class="form-group">
              <label for="birthday">Birthday</label>
              <input type="date" id="birthday" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>

              <div class="form-group">
                <label for="gradeLevel">Grade Level</label>
                <select id="gradeLevel">
                  <option value="">Select Grade</option>
                  <option value="1">Grade 1</option>
                  <option value="2">Grade 2</option>
                  <option value="3">Grade 3</option>
                  <option value="4">Grade 4</option>
                  <option value="5">Grade 5</option>
                  <option value="6">Grade 6</option>
                  <option value="7">Grade 7</option>
                  <option value="8">Grade 8</option>
                  <option value="9">Grade 9</option>
                  <option value="10">Grade 10</option>
                  <option value="11">Grade 11</option>
                  <option value="12">Grade 12</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="language">Preferred Language</label>
              <select id="language">
                <option value="">Select Language</option>
                <option value="Sinhala">Sinhala</option>
                <option value="English">English</option>
                <option value="Tamil">Tamil</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary">
              üíæ Update Profile
            </button>
          </form>
        </div>

        <!-- Change Password -->
        <div class="profile-card">
          <h2 class="card-title">üîê Change Password</h2>
          <form id="changePasswordForm">
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input
                type="password"
                id="currentPassword"
                placeholder="Enter current password"
                required
              />
            </div>

            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input
                type="password"
                id="newPassword"
                placeholder="Enter new password (min 6 characters)"
                required
              />
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="Confirm new password"
                required
              />
            </div>

            <button type="submit" class="btn btn-primary">
              üîÑ Change Password
            </button>
          </form>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h3>‚ö†Ô∏è Danger Zone</h3>
            <p>
              Deactivating your account will disable access to all features. You
              can contact support to reactivate your account.
            </p>
            <button id="deleteAccountBtn" class="btn btn-danger">
              üóëÔ∏è Deactivate Account
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:8000";
      let authToken = localStorage.getItem("access_token"); // Changed from "authToken" to "access_token"

      console.log("Profile page loaded");
      console.log("Auth token:", authToken ? "Present" : "Missing");
      console.log("Auth token value:", authToken);

      // Check authentication
      if (!authToken || authToken === "null" || authToken === "undefined") {
        console.log("No valid auth token found, redirecting to login");
        alert("Please login first to access your profile");
        window.location.href = "login.html";
        throw new Error("No authentication token"); // Stop script execution
      }

      console.log("Authentication check passed, loading profile...");

      // Elements
      const alertSuccess = document.getElementById("alertSuccess");
      const alertError = document.getElementById("alertError");
      const loading = document.getElementById("loading");

      // Show alert functions
      function showSuccess(message) {
        alertSuccess.textContent = message;
        alertSuccess.classList.add("show");
        alertError.classList.remove("show");
        setTimeout(() => alertSuccess.classList.remove("show"), 5000);
      }

      function showError(message) {
        alertError.textContent = message;
        alertError.classList.add("show");
        alertSuccess.classList.remove("show");
        setTimeout(() => alertError.classList.remove("show"), 5000);
      }

      function showLoading(show = true) {
        if (show) {
          loading.classList.add("show");
        } else {
          loading.classList.remove("show");
        }
      }

      // Fetch user profile
      async function loadProfile() {
        showLoading(true);
        try {
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            if (response.status === 401) {
              // Token expired or invalid
              localStorage.removeItem("access_token");
              localStorage.removeItem("username");
              window.location.href = "login.html";
              return;
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "Failed to load profile");
          }

          const user = await response.json();
          displayProfile(user);
          populateForm(user);

          // Load stats after profile loads successfully
          await loadStats();
        } catch (error) {
          showError("Failed to load profile: " + error.message);
          console.error("Profile load error:", error);
        } finally {
          showLoading(false);
        }
      }

      // Fetch account statistics
      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE_URL}/profile/stats`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "Failed to load statistics");
          }

          const stats = await response.json();
          displayStats(stats);
        } catch (error) {
          console.error("Failed to load stats:", error);
          // Don't show error to user, just log it
          // Show default values instead
          document.getElementById("statAge").textContent = "-";
          document.getElementById("statGrade").textContent = "-";
          document.getElementById("statAccountAge").textContent = "-";
          document.getElementById("statCreated").textContent = "-";
          document.getElementById("statLastLogin").textContent = "-";
        }
      }

      // Display profile information
      function displayProfile(user) {
        document.getElementById(
          "displayFullName"
        ).textContent = `${user.first_name} ${user.last_name}`;
        document.getElementById("displayEmail").textContent = user.email;
        document.getElementById("displayPhone").textContent = user.phone_number;
        document.getElementById("displayBirthday").textContent = formatDate(
          user.birthday
        );

        // Calculate age
        const age = calculateAge(user.birthday);
        document.getElementById("displayAge").textContent = `${age} years`;
        document.getElementById("displayGender").textContent = user.gender;
        document.getElementById(
          "displayGrade"
        ).textContent = `Grade ${user.grade_level}`;
        document.getElementById("displayLanguage").textContent = user.language;

        const statusBadge = document.getElementById("displayStatus");
        statusBadge.textContent = user.is_active ? "Active" : "Inactive";
        statusBadge.className = user.is_active
          ? "status-badge status-active"
          : "status-badge status-inactive";
      }

      // Display statistics
      function displayStats(stats) {
        document.getElementById("statAge").textContent = stats.age;
        document.getElementById("statGrade").textContent = stats.grade_level;
        document.getElementById("statAccountAge").textContent =
          stats.account_age_days;
        document.getElementById("statCreated").textContent = formatDateTime(
          stats.account_created
        );
        document.getElementById("statLastLogin").textContent = stats.last_login
          ? formatDateTime(stats.last_login)
          : "Never";
      }

      // Populate form with current data
      function populateForm(user) {
        document.getElementById("firstName").value = user.first_name;
        document.getElementById("lastName").value = user.last_name;
        document.getElementById("phoneNumber").value = user.phone_number;
        document.getElementById("birthday").value = user.birthday;
        document.getElementById("gender").value = user.gender;
        document.getElementById("gradeLevel").value = user.grade_level;
        document.getElementById("language").value = user.language;
      }

      // Update profile form submission
      document
        .getElementById("updateProfileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const updateData = {
            first_name: document.getElementById("firstName").value.trim(),
            last_name: document.getElementById("lastName").value.trim(),
            phone_number: document.getElementById("phoneNumber").value.trim(),
            birthday: document.getElementById("birthday").value,
            gender: document.getElementById("gender").value,
            grade_level: parseInt(document.getElementById("gradeLevel").value),
            language: document.getElementById("language").value,
          };

          // Remove empty fields
          Object.keys(updateData).forEach((key) => {
            if (
              updateData[key] === "" ||
              updateData[key] === null ||
              updateData[key] === undefined
            ) {
              delete updateData[key];
            }
          });

          // Remove grade_level if it's NaN
          if (isNaN(updateData.grade_level)) {
            delete updateData.grade_level;
          }

          if (Object.keys(updateData).length === 0) {
            showError("Please fill at least one field to update");
            return;
          }

          showLoading(true);
          try {
            const response = await fetch(`${API_BASE_URL}/profile/update`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify(updateData),
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || "Failed to update profile");
            }

            const user = await response.json();
            displayProfile(user);
            showSuccess("‚úÖ Profile updated successfully!");
            loadStats(); // Reload stats
          } catch (error) {
            showError("‚ùå " + error.message);
          } finally {
            showLoading(false);
          }
        });

      // Change password form submission
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showError("‚ùå New passwords do not match");
            return;
          }

          if (newPassword.length < 6) {
            showError("‚ùå Password must be at least 6 characters");
            return;
          }

          showLoading(true);
          try {
            const response = await fetch(
              `${API_BASE_URL}/profile/change-password`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                  current_password: currentPassword,
                  new_password: newPassword,
                  confirm_password: confirmPassword,
                }),
              }
            );

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || "Failed to change password");
            }

            showSuccess("‚úÖ Password changed successfully!");
            document.getElementById("changePasswordForm").reset();
          } catch (error) {
            showError("‚ùå " + error.message);
          } finally {
            showLoading(false);
          }
        });

      // Delete account
      document
        .getElementById("deleteAccountBtn")
        .addEventListener("click", async () => {
          if (
            !confirm(
              "‚ö†Ô∏è Are you sure you want to deactivate your account? This action will disable your access to all features."
            )
          ) {
            return;
          }

          if (
            !confirm(
              "üî¥ FINAL WARNING: This will deactivate your account. You'll need to contact support to reactivate. Continue?"
            )
          ) {
            return;
          }

          showLoading(true);
          try {
            const response = await fetch(`${API_BASE_URL}/profile/delete`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${authToken}`,
              },
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || "Failed to deactivate account");
            }

            showSuccess("Account deactivated. Redirecting to login page...");
            localStorage.removeItem("access_token");
            localStorage.removeItem("username");
            setTimeout(() => {
              window.location.href = "login.html";
            }, 2000);
          } catch (error) {
            showError("‚ùå " + error.message);
          } finally {
            showLoading(false);
          }
        });

      // Utility functions
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function calculateAge(birthday) {
        const birthDate = new Date(birthday);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && today.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        return age;
      }

      // Load data on page load
      loadProfile();
      // Stats will be loaded after profile loads successfully
    </script>
  </body>
</html>

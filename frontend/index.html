<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- SEO Meta Tags -->
    <title>
      Prasad K. Gamage - AI Learning Assistant for Sri Lankan Students | Grade
      1-13
    </title>
    <meta
      name="description"
      content="Learn with Prasad K. Gamage - Your dedicated AI tutor for Sri Lankan students from Grade 1 to Grade 13. Get expert help with Mathematics, Science, Sinhala, English, and all subjects in the Sri Lankan curriculum."
    />
    <meta
      name="keywords"
      content="Prasad K. Gamage, Sri Lanka education, AI tutor, learning assistant, grade 1-13, O/L tuition, A/L tuition, Sri Lankan curriculum, mathematics help, science tutor, online learning Sri Lanka, education Sri Lanka"
    />
    <meta name="author" content="Prasad K. Gamage" />
    <meta name="robots" content="index, follow" />

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Prasad K. Gamage - AI Learning Assistant for Sri Lankan Students"
    />
    <meta
      property="og:description"
      content="Expert learning support for Sri Lankan students Grade 1-13. Get help with all subjects in Sinhala, English, and Tamil medium."
    />
    <meta
      property="og:site_name"
      content="Prasad K. Gamage Learning Assistant"
    />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Prasad K. Gamage - Sri Lankan Education Tutor"
    />
    <meta
      name="twitter:description"
      content="AI-powered learning assistant for Sri Lankan students. O/L, A/L and all grades."
    />

    <!-- Preconnect to external resources for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <!-- Highlight.js for code syntax highlighting -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .chat-container {
        width: 100%;
        max-width: 800px;
        height: 600px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-title {
        font-size: 20px;
        font-weight: bold;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 14px;
      }

      .user-name {
        opacity: 0.9;
      }

      .profile-btn {
        padding: 6px 16px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .profile-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .logout-btn {
        padding: 6px 16px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .chat-mode {
        background: #f5f5f5;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        border-bottom: 1px solid #ddd;
      }

      .mode-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background: white;
        color: #667eea;
        font-weight: 500;
        transition: all 0.3s;
      }

      .mode-btn.active {
        background: #667eea;
        color: white;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .message {
        display: flex;
        gap: 10px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 15px;
        word-wrap: break-word;
      }

      .message.user .message-content {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 5px;
      }

      .message.assistant .message-content {
        background: #f0f0f0;
        color: #333;
        border-bottom-left-radius: 5px;
      }

      /* Markdown styling */
      .message-content pre {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        overflow-x: auto;
        max-width: 100%;
      }

      .message-content code {
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
      }

      .message-content pre code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        color: #e6e6e6;
      }

      .message-content code:not(pre code) {
        background: #e8e8e8;
        padding: 2px 6px;
        border-radius: 3px;
        color: #c7254e;
        font-size: 13px;
      }

      .message.user .message-content code:not(pre code) {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      .message-content h1,
      .message-content h2,
      .message-content h3 {
        margin: 15px 0 10px 0;
        font-weight: 600;
      }

      .message-content h1 {
        font-size: 1.5em;
      }
      .message-content h2 {
        font-size: 1.3em;
      }
      .message-content h3 {
        font-size: 1.1em;
      }

      .message-content ul,
      .message-content ol {
        margin: 10px 0;
        padding-left: 25px;
      }

      .message-content li {
        margin: 5px 0;
      }

      .message-content p {
        margin: 8px 0;
        line-height: 1.6;
      }

      .message-content blockquote {
        border-left: 4px solid #667eea;
        padding-left: 15px;
        margin: 10px 0;
        color: #666;
        font-style: italic;
      }

      .message-content strong {
        font-weight: 600;
      }

      .message-content a {
        color: #667eea;
        text-decoration: none;
      }

      .message-content a:hover {
        text-decoration: underline;
      }

      .chat-input-area {
        padding: 20px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }

      #messageInput {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s;
      }

      #messageInput:focus {
        border-color: #667eea;
      }

      #sendBtn {
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      #sendBtn:hover {
        transform: scale(1.05);
      }

      #sendBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: scale(1);
      }

      .loading {
        display: flex;
        gap: 5px;
        padding: 12px 16px;
      }

      .loading-dot {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }

      .loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="header-title">
          Prasad K. Gamage - Sri Lankan Students Learning Assistant ðŸ‡±ðŸ‡°
        </div>
        <div class="user-info">
          <span class="user-name" id="userName">Guest</span>
          <a href="profile.html" class="profile-btn">ðŸ‘¤ Profile</a>
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>
      <div class="chat-mode">
        <button class="mode-btn active" data-mode="session">
          Session Mode (with memory)
        </button>
        <button class="mode-btn" data-mode="stateless">
          Simple Mode (no memory)
        </button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          <div class="message-content">
            Hello! I'm Prasad K. Gamage, your learning assistant. I'm here to
            help Sri Lankan students from Grade 1 to Grade 13 with all subjects.
            How can I help you with your studies today?
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message here..."
          autocomplete="off"
        />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:8000"; // Backend API server
      let sessionId = null;
      let currentMode = "session";
      let isLoading = false;
      let currentUser = null;
      let accessToken = null;

      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const modeButtons = document.querySelectorAll(".mode-btn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userNameElement = document.getElementById("userName");

      // Check authentication on page load
      async function checkAuth() {
        accessToken = localStorage.getItem("access_token");

        if (!accessToken) {
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (!response.ok) {
            throw new Error("Invalid token");
          }

          currentUser = await response.json();
          userNameElement.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
          console.log("Logged in as:", currentUser.email);
        } catch (error) {
          console.error("Authentication failed:", error);
          localStorage.clear();
          window.location.href = "login.html";
        }
      }

      // Logout function
      logoutBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.clear();
          window.location.href = "login.html";
        }
      });

      // Initialize session on load
      async function initSession() {
        try {
          const accessToken = localStorage.getItem("access_token");
          if (!accessToken) {
            showError("Please login to start a chat session");
            window.location.href = "login.html";
            return;
          }

          const response = await fetch(`${API_URL}/chat/session`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.status === 401) {
            showError("Session expired. Please login again.");
            localStorage.clear();
            window.location.href = "login.html";
            return;
          }

          const data = await response.json();
          sessionId = data.session_id;
          console.log("Session initialized:", sessionId);
        } catch (error) {
          showError(
            "Failed to initialize session. Make sure the API server is running."
          );
          console.error("Session init error:", error);
        }
      }

      // Switch between modes
      modeButtons.forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (isLoading) return;

          modeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentMode = btn.dataset.mode;

          // Clear chat and reinitialize
          clearChat();
          if (currentMode === "session") {
            await initSession();
            addMessage(
              "assistant",
              "Session mode activated. I'm Prasad K. Gamage, and I'll remember our learning conversation to help you better!"
            );
          } else {
            addMessage(
              "assistant",
              "Simple mode activated. I'm Prasad K. Gamage, ready to help with your studies."
            );
          }
        });
      });

      // Add message to chat
      function addMessage(role, content, isMarkdown = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        if (isMarkdown && role === "assistant") {
          // Parse markdown and render HTML
          contentDiv.innerHTML = marked.parse(content);
          // Highlight code blocks
          contentDiv.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          contentDiv.textContent = content;
        }

        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Show loading indicator
      function showLoading() {
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message assistant";
        loadingDiv.id = "loadingIndicator";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content loading";
        contentDiv.innerHTML =
          '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';

        loadingDiv.appendChild(contentDiv);
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Remove loading indicator
      function removeLoading() {
        const loading = document.getElementById("loadingIndicator");
        if (loading) loading.remove();
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        chatMessages.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }

      // Clear chat
      function clearChat() {
        chatMessages.innerHTML = "";
      }

      // Send message
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isLoading) return;

        // Add user message to chat
        addMessage("user", message);
        messageInput.value = "";

        // Show loading
        isLoading = true;
        sendBtn.disabled = true;
        showLoading();

        try {
          let response;

          if (currentMode === "session") {
            // Session mode
            if (!sessionId) {
              await initSession();
            }
            response = await fetch(`${API_URL}/chat/session/${sessionId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({ message }),
            });
          } else {
            // Stateless mode
            response = await fetch(`${API_URL}/chat`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({ message }),
            });
          }

          if (!response.ok) {
            throw new Error("API request failed");
          }

          const data = await response.json();
          removeLoading();
          addMessage("assistant", data.response, true);
        } catch (error) {
          removeLoading();
          showError(
            "Failed to send message. Please make sure the API server is running on http://localhost:8000"
          );
          console.error("Send message error:", error);
        } finally {
          isLoading = false;
          sendBtn.disabled = false;
          messageInput.focus();
        }
      }

      // Event listeners
      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // Initialize on load
      checkAuth().then(() => {
        // Only initialize session if in session mode
        if (currentMode === "session") {
          initSession();
        }
        messageInput.focus();
      });
    </script>
  </body>
</html>
